#!/bin/bash
#
# This script is run on every ami change.
#+ This is the place to do things like database initilizations and migrations.
#
#set -x
[ -e /usr/local/lib/nubis/nubis-lib.sh ] && . /usr/local/lib/nubis/nubis-lib.sh || exit 1

# Check to see if consul is up
consul_up

# Check to see if elastic IP key is up on consul
key_up "ElasticIP"

elasticip_id=$(curl -s -fq ${CONSUL}/ElasticIP?raw=1)

if [[ -z "${INSTANCE_ID}" ]]; then
    logmsg migrate "ERROR: Instance ID not found"
    exit 1
fi

if [[ -z "${INSTANCE_IP}" ]]; then
    logmsg migrate "ERROR: Instance IP not found"
    exit 1
fi

logmsg migrate "Associating ${elasticip_id} to ${INSTANCE_ID}
aws ec2 associate-address --instance-id ${INSTANCE_ID} --allocation-id ${elasticip_id} --private-ip-address ${INSTANCE_IP} --region ${EC2_REGION}
RV=$?

if [[ ${RV} != 0 ]]; then
    logmsg migrate "ERROR: Unable to associate elastic IP ${elasticip_id} to instance ${INSTANCE_ID}"
    exit 1
fi
